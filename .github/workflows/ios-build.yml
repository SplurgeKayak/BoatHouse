name: iOS Build & Screenshot

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available destinations
      run: xcodebuild -project Boathouse.xcodeproj -scheme Boathouse -showdestinations 2>/dev/null | head -50 || true

    - name: List available simulators
      run: xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

    - name: Build for Simulator
      run: |
        set -o pipefail
        xcodebuild build \
          -project Boathouse.xcodeproj \
          -scheme Boathouse \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=YES \
          2>&1 | tee build.log
      continue-on-error: true

    - name: Check build result
      run: |
        if grep -q "BUILD SUCCEEDED" build.log; then
          echo "Build succeeded!"
        else
          echo "Build may have issues, checking for app..."
        fi

    - name: Find built app
      id: find_app
      run: |
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Boathouse.app" -type d 2>/dev/null | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "Found app at: $APP_PATH"
        else
          echo "App not found in DerivedData"
          echo "app_path=" >> $GITHUB_OUTPUT
        fi

    - name: Boot Simulator
      if: steps.find_app.outputs.app_path != ''
      run: |
        xcrun simctl boot "iPhone 15" 2>/dev/null || true
        sleep 5
        xcrun simctl list devices booted

    - name: Install and Launch App
      if: steps.find_app.outputs.app_path != ''
      run: |
        xcrun simctl install booted "${{ steps.find_app.outputs.app_path }}"
        xcrun simctl launch booted com.boathouse.app
        sleep 3

    - name: Take Screenshots
      if: steps.find_app.outputs.app_path != ''
      run: |
        mkdir -p screenshots
        xcrun simctl io booted screenshot screenshots/01-app-launch.png
        sleep 2
        xcrun simctl io booted screenshot screenshots/02-app-loaded.png

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-screenshots
        path: screenshots/
        if-no-files-found: ignore

    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore
