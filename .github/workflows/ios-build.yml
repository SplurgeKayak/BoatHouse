name: iOS Build & Screenshot

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: xcrun simctl list devices available | grep -E "iPhone 15" | head -10

    - name: Create and boot simulator
      id: simulator
      run: |
        # Get the iPhone 15 simulator UDID
        UDID=$(xcrun simctl list devices available | grep "iPhone 15 Pro (" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
        if [ -z "$UDID" ]; then
          UDID=$(xcrun simctl list devices available | grep "iPhone 15 (" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
        fi
        echo "Using simulator UDID: $UDID"
        echo "udid=$UDID" >> $GITHUB_OUTPUT

        # Boot the simulator
        xcrun simctl boot "$UDID" 2>/dev/null || true

        # Wait for simulator to fully boot
        echo "Waiting for simulator to boot..."
        sleep 10

        # Verify it's booted
        xcrun simctl list devices booted

    - name: Build for Simulator
      run: |
        set -o pipefail

        # Enable verbose Swift compiler diagnostics
        xcodebuild build \
          -project Boathouse.xcodeproj \
          -scheme Boathouse \
          -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.udid }}" \
          -configuration Debug \
          -derivedDataPath ./DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=YES \
          OTHER_SWIFT_FLAGS="-Xfrontend -warn-long-expression-type-checking=200 -Xfrontend -warn-long-function-bodies=200" \
          GCC_WARN_INHIBIT_ALL_WARNINGS=NO \
          SWIFT_SUPPRESS_WARNINGS=NO \
          2>&1 | tee build.log

        BUILD_EXIT_CODE=${PIPESTATUS[0]}

        echo ""
        echo "=========================================="
        echo "Build completed with exit code: $BUILD_EXIT_CODE"
        echo "=========================================="

        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "✅ Build succeeded!"
        else
          echo "❌ Build failed with exit code $BUILD_EXIT_CODE"
          echo ""
          echo "=========================================="
          echo "COMPILER ERRORS AND WARNINGS:"
          echo "=========================================="
          # Extract and display all error and warning lines with context
          grep -E "(error:|warning:|note:)" build.log || echo "No explicit error/warning lines found"
          echo ""
          echo "=========================================="
          echo "LAST 200 LINES OF BUILD LOG:"
          echo "=========================================="
          tail -200 build.log
          exit $BUILD_EXIT_CODE
        fi

    - name: Find built app
      id: find_app
      run: |
        APP_PATH="./DerivedData/Build/Products/Debug-iphonesimulator/Boathouse.app"
        if [ -d "$APP_PATH" ]; then
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
          echo "✅ Found app at: $APP_PATH"
          ls -la "$APP_PATH"
          # Verify binary exists
          if [ -f "$APP_PATH/Boathouse" ]; then
            echo "✅ Binary exists!"
          else
            echo "❌ Binary missing!"
            ls -la "$APP_PATH/"
          fi
        else
          echo "❌ App not found at expected path"
          find ./DerivedData -name "*.app" -type d 2>/dev/null || echo "No .app found"
          echo "app_path=" >> $GITHUB_OUTPUT
        fi

    - name: Install App on Simulator
      if: steps.find_app.outputs.app_path != ''
      run: |
        echo "Installing app on simulator..."
        xcrun simctl install booted "${{ steps.find_app.outputs.app_path }}"
        echo "✅ App installed"

    - name: Launch App and Take Screenshots
      if: steps.find_app.outputs.app_path != ''
      run: |
        mkdir -p screenshots

        # Set status bar to a consistent time for clean screenshots
        xcrun simctl status_bar booted override --time "9:41" --batteryLevel 100 --batteryState charged

        echo "Launching app..."
        xcrun simctl launch booted com.boathouse.app

        # Wait for app to fully launch and render
        echo "Waiting for app to load..."
        sleep 5

        # Take screenshot of launch/loading screen
        echo "Taking screenshot 1 - Initial load..."
        xcrun simctl io booted screenshot screenshots/01-initial-load.png

        # Wait for content to load
        sleep 5

        # Take screenshot of main content
        echo "Taking screenshot 2 - Main content..."
        xcrun simctl io booted screenshot screenshots/02-main-screen.png

        # Wait a bit more
        sleep 3

        # Take another screenshot
        echo "Taking screenshot 3 - App ready..."
        xcrun simctl io booted screenshot screenshots/03-app-ready.png

        echo "Screenshots taken:"
        ls -la screenshots/

    - name: Take Simulator Screenshot (fallback)
      if: always()
      run: |
        mkdir -p screenshots
        # Try to take a screenshot of whatever is on screen
        xcrun simctl io booted screenshot screenshots/00-simulator-state.png 2>/dev/null || echo "Could not capture simulator screenshot"

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-screenshots
        path: screenshots/
        if-no-files-found: warn

    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        if-no-files-found: ignore

    - name: Upload DerivedData (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: derived-data-debug
        path: |
          ./DerivedData/Build/Products/
          ./DerivedData/Logs/
        if-no-files-found: ignore
