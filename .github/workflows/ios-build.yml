name: iOS Build & Screenshot

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: Show Xcode version
      run: xcodebuild -version

    - name: List available simulators
      run: xcrun simctl list devices available

    - name: Build for Simulator
      run: |
        xcodebuild build \
          -project Boathouse.xcodeproj \
          -scheme Boathouse \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty || true

    - name: Boot Simulator
      run: |
        UDID=$(xcrun simctl list devices available | grep "iPhone 15" | grep -v unavailable | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
        echo "Booting simulator: $UDID"
        xcrun simctl boot "$UDID" || true
        sleep 5

    - name: Install App on Simulator
      run: |
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Boathouse.app" -type d | head -1)
        echo "Installing app from: $APP_PATH"
        if [ -n "$APP_PATH" ]; then
          xcrun simctl install booted "$APP_PATH"
        fi

    - name: Launch App
      run: |
        xcrun simctl launch booted com.boathouse.app || true
        sleep 3

    - name: Take Screenshots
      run: |
        mkdir -p screenshots
        xcrun simctl io booted screenshot screenshots/01-launch.png || true
        sleep 2
        xcrun simctl io booted screenshot screenshots/02-home.png || true

    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: ios-screenshots
        path: screenshots/
        if-no-files-found: warn

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Boathouse-Debug
        path: ~/Library/Developer/Xcode/DerivedData/**/Build/Products/Debug-iphonesimulator/Boathouse.app
        if-no-files-found: warn
