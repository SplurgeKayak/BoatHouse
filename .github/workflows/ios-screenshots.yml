name: iOS Screenshot Gallery

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Simulator device'
        required: true
        default: 'iPhone 15'
        type: choice
        options:
          - iPhone 15
          - iPhone 15 Pro
          - iPhone 15 Pro Max
          - iPhone SE (3rd generation)
          - iPad Pro (12.9-inch) (6th generation)

jobs:
  screenshots:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: Create Screenshots Directory
      run: mkdir -p screenshots

    - name: Build App
      run: |
        xcodebuild build \
          -project Boathouse.xcodeproj \
          -scheme Boathouse \
          -destination 'platform=iOS Simulator,name=${{ inputs.device }},OS=17.0' \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build.log || true

    - name: Boot Simulator
      run: |
        DEVICE_NAME="${{ inputs.device }}"
        xcrun simctl boot "$DEVICE_NAME" 2>/dev/null || true
        sleep 5

        # Set appearance to light mode
        xcrun simctl ui booted appearance light

    - name: Install and Launch App
      run: |
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Boathouse.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          xcrun simctl install booted "$APP_PATH"
          xcrun simctl launch booted com.boathouse.app
          sleep 3
        else
          echo "App not found!"
          exit 1
        fi

    - name: Capture Launch Screen
      run: |
        xcrun simctl io booted screenshot screenshots/01-launch-screen.png
        sleep 2

    - name: Capture Login Screen
      run: |
        xcrun simctl io booted screenshot screenshots/02-login-screen.png

    - name: Record Video (5 seconds)
      run: |
        xcrun simctl io booted recordVideo --time 5 screenshots/app-preview.mp4 || true

    - name: Take Dark Mode Screenshots
      run: |
        xcrun simctl ui booted appearance dark
        sleep 1
        xcrun simctl io booted screenshot screenshots/03-dark-mode.png

    - name: Generate Screenshot Report
      run: |
        echo "# Boathouse iOS Screenshots" > screenshots/README.md
        echo "" >> screenshots/README.md
        echo "Device: ${{ inputs.device }}" >> screenshots/README.md
        echo "Generated: $(date)" >> screenshots/README.md
        echo "" >> screenshots/README.md
        echo "## Screenshots" >> screenshots/README.md
        for f in screenshots/*.png; do
          if [ -f "$f" ]; then
            echo "### $(basename $f .png)" >> screenshots/README.md
            echo "![$(basename $f)]($(basename $f))" >> screenshots/README.md
            echo "" >> screenshots/README.md
          fi
        done

    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: boathouse-screenshots-${{ inputs.device }}
        path: screenshots/
        retention-days: 30

    - name: Upload Build Log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
